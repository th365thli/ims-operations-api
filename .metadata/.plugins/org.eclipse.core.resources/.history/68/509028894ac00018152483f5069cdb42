/*********************************************************************************
 * Licensed Materials - Property of IBM
 * 5655-TAC
 * (C) Copyright IBM Corp. 2013 All Rights Reserved. 
 * US Government Users Restricted Rights - Use, duplication or
 * disclosure restricted by GSA ADP Schedule Contract with 
 * IBM Corp.               
 *********************************************************************************/

package com.ibm.ims.ea.om.common.services;


import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collection;
import java.util.Map;
import java.util.Properties;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import com.ibm.ims.ea.base.version.Version;
import com.ibm.ims.ea.om.cmd.v14.query.imsplex.QueryImsPlex;
import com.ibm.ims.ea.om.common.exception.OmConnectionException;
import com.ibm.ims.ea.om.common.exception.OmDatastoreException;
import com.ibm.ims.ea.om.common.exception.OmException;
import com.ibm.ims.ea.om.common.result.OmResultSet;
import com.ibm.ims.ea.om.common.service.StructureService;
import com.ibm.ims.ea.om.datastore.ImsBaseDastoreConstants;
import com.ibm.ims.ea.om.structure.Struct;
/**
 * <pre>
 * Class provides methods to interact with OM for IMS Connect Resource type. 
 * Return types are generalized for all interactions as a Collection of {@link Icon} objects. 
 * 
 * It should be noted that the Collection only manages the response for the particular 
 * resource and that OM Messages including Reason Codes, Reason Text, etc are accessible 
 * from the {@link Om} instance managing the interaction. 
 * 
 * See  <code>{@link Om#getOmMessageContexts()} </code> on how to access OM Messages.
 * </pre>
 * 
 * @author ddimatos
 *
 */
public final class StructureServices extends ServicesHelper implements StructureService{

	private static final Logger logger = LoggerFactory.getLogger(StructureServices.class);
	private static final ArrayList<String> STRUCTURE_HEADERS_V14 = new ArrayList<String>(Arrays.asList("STRUCTURE_NAME","TYPE","STATUS"));

	//This must remain protected else the Om instance will not be able to aggregate all the Om Messages
	protected StructureServices(Om om) {
		super(om);
		
		try {
			this.resourceVersion = om.getImsplexService().getResourceVersions(new QueryImsPlex.TypeOptions[]{QueryImsPlex.TypeOptions.IMS});
		} catch (Exception e) {
			version = Version.IMS_ZERO_RELEASE;
		}
	}

	@Override
	public Collection<Struct> getImsStructure() throws OmException, OmConnectionException, OmDatastoreException {
		if(logger.isDebugEnabled()) logger.debug(">> getImsStructure()");

		//Note the method key to be used for associating the service
		String methodKey = "getImsStructure";
		
		//Local omresultSet otherwise we risk data corruption of the service is reused. 
		OmResultSet omResultSet = null;
		
		try{
			//Set and configure the version using mapped resource version and the route name
			this.version = this.resourceVersion.get("latestResourceVersion");
			
			String cmd ="CMD((DISPLAY STRUC ALL) OPTION=AOPOUTPUT)";
			
        	Service service = new Service(this.om, this.version);
			omResultSet = service.executeCommand(methodKey,cmd);
			
			return propertiesToCollection(omResultSet);
		}finally{
			if(logger.isDebugEnabled()) logger.debug("<< getImsStructure()");
			   
			this.setOmInteractionContext(omResultSet, methodKey, STRUCTURE_HEADERS_V14);
		}
	}

	@Override
	public Collection<Struct> getImsStructure(String[] imsSystemName) throws OmException, OmConnectionException, OmDatastoreException {
		if(logger.isDebugEnabled()) logger.debug(">> getImsStructure()");

		//Note the method key to be used for associating the service
		String methodKey = "getImsStructure";
		
		//Local omresultSet otherwise we risk data corruption of the service is reused. 
		OmResultSet omResultSet = null;
		
		try{
			
			imsSystemName = this.routeMemberFormater(imsSystemName);

			//Set and configure the version using mapped resource version and the route name
			this.version = this.setVersion(this.resourceVersion , imsSystemName);
			
			String cmd ="CMD((DISPLAY STRUC ALL) OPTION=AOPOUTPUT) ROUTE(";
	
			int nRoute = imsSystemName.length;
			int counter =0;
	
			while(counter < nRoute)
			{       
				cmd = cmd+imsSystemName[counter];
				counter = counter +1;
				if(counter == nRoute)
					cmd = cmd + ")";
				else
					cmd = cmd +",";
			}
	
        	Service service = new Service(this.om, this.version);
			omResultSet = service.executeCommand(methodKey,cmd);
			
			return propertiesToCollection(omResultSet);
		}finally{
			if(logger.isDebugEnabled()) logger.debug("<< getImsStructure()");
			
			this.setOmInteractionContext(omResultSet, methodKey, STRUCTURE_HEADERS_V14);
		}
	}

	/**
	 * Method will map a omResulset to a collection of transaction beans. It will also
	 * append to each bean the sysplex and imsplex name. 
	 * @param omResultSet
	 * @return
	 */
    private Collection<Struct> propertiesToCollection(OmResultSet omResultSet) {
        Collection<Struct> tempList = new ArrayList<Struct>();

        Properties[] properties = omResultSet.getResponseProperties();

        for (Properties p : properties) {
           	Struct struct = new Struct();
           	struct.setMap((Map)p);
           	struct.getMap().put(ImsBaseDastoreConstants.SYSPLEX_ID, omResultSet.getEnvironment());
           	struct.getMap().put(ImsBaseDastoreConstants.IMSPLX, omResultSet.getImsplex());
            tempList.add(struct);
        }

        return tempList;
    }

}
